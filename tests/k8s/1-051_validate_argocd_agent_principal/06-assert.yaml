apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 120
---
apiVersion: argoproj.io/v1beta1
kind: ArgoCD
metadata:
  name: argocd
  namespace: argocd-e2e-cluster-config
status:
  phase: Available
---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: argocd-agent-principal
  namespace: argocd-e2e-cluster-config
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-agent-principal
  namespace: argocd-e2e-cluster-config
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-agent-principal
  namespace: argocd-e2e-cluster-config 
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
 name: argocd-argocd-e2e-cluster-config-agent-principal  
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: argocd-argocd-e2e-cluster-config-agent-principal
---
apiVersion: v1
kind: Service
metadata:
  name: argocd-agent-principal
  namespace: argocd-e2e-cluster-config
spec:
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: argocd-agent-principal-metrics
  namespace: argocd-e2e-cluster-config
spec:
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: argocd-redis
  namespace: argocd-e2e-cluster-config
spec:
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: argocd-repo-server
  namespace: argocd-e2e-cluster-config
spec:
  type: ClusterIP  
---
apiVersion: v1
kind: Service
metadata:
  name: argocd-server
  namespace: argocd-e2e-cluster-config
spec:
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: argocd-agent-principal-redisproxy
  namespace: argocd-e2e-cluster-config  
spec:
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-redis
  namespace: argocd-e2e-cluster-config
status:
  readyReplicas: 1  
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-repo-server
  namespace: argocd-e2e-cluster-config
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-server
  namespace: argocd-e2e-cluster-config
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-agent-principal
  namespace: argocd-e2e-cluster-config
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: argocd-agent-principal
        image: quay.io/argoprojlabs/argocd-agent:v0.3.2
        env:
          - name: ARGOCD_PRINCIPAL_LOG_LEVEL
            value: info
          - name: ARGOCD_PRINCIPAL_NAMESPACE
            value: argocd-e2e-cluster-config
          - name: ARGOCD_PRINCIPAL_ALLOWED_NAMESPACES
            value: '*'
          - name: ARGOCD_PRINCIPAL_NAMESPACE_CREATE_ENABLE
            value: 'false'
          - name: ARGOCD_PRINCIPAL_NAMESPACE_CREATE_PATTERN
          - name: ARGOCD_PRINCIPAL_NAMESPACE_CREATE_LABELS
          - name: ARGOCD_PRINCIPAL_TLS_SERVER_ALLOW_GENERATE
            value: 'true'
          - name: ARGOCD_PRINCIPAL_JWT_ALLOW_GENERATE
            value: 'true'
          - name: ARGOCD_PRINCIPAL_AUTH
            value: 'mtls:CN=([^,]+)'
          - name: ARGOCD_PRINCIPAL_ENABLE_RESOURCE_PROXY
            value: 'true'
          - name: ARGOCD_PRINCIPAL_KEEP_ALIVE_MIN_INTERVAL
            value: 30s
          - name: ARGOCD_PRINCIPAL_REDIS_SERVER_ADDRESS
            value: 'argocd-redis:6379'
          - name: ARGOCD_PRINCIPAL_REDIS_COMPRESSION_TYPE
            value: gzip
          - name: ARGOCD_PRINCIPAL_LOG_FORMAT
            value: text
          - name: ARGOCD_PRINCIPAL_ENABLE_WEBSOCKET
            value: 'false'
          - name: ARGOCD_PRINCIPAL_TLS_SECRET_NAME
            value: argocd-agent-principal-tls
          - name: ARGOCD_PRINCIPAL_TLS_SERVER_ROOT_CA_SECRET_NAME
            value: argocd-agent-ca
          - name: ARGOCD_PRINCIPAL_RESOURCE_PROXY_SECRET_NAME
            value: argocd-agent-resource-proxy-tls
          - name: ARGOCD_PRINCIPAL_RESOURCE_PROXY_CA_SECRET_NAME
            value: argocd-agent-ca
          - name: ARGOCD_PRINCIPAL_JWT_SECRET_NAME
            value: argocd-agent-jwt
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: argocd-redis
                key: auth
                optional: true
          - name: TEST_ENV
            value: test_value
status:
  readyReplicas: 1
