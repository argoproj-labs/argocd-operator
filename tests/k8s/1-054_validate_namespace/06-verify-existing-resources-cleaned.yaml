---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
- script: sleep 60
- script: |
    set -e
    # Verify Role
    role=$(kubectl get role -n test-054-existing-source example-argocd-existing_test-054-existing-source -o jsonpath='{.metadata.name}' 2>/dev/null || echo "")
    if [ -n "$role" ]; then
      echo "ERROR: Role still exists: $role"
      exit 1
    fi
    echo "SUCCESS: Role was deleted"
- script: |
    set -e
    # Verify RoleBinding
    rb=$(kubectl get rolebinding -n test-054-existing-source example-argocd-existing_test-054-existing-source -o jsonpath='{.metadata.name}' 2>/dev/null || echo "")
    if [ -n "$rb" ]; then
      echo "ERROR: RoleBinding still exists: $rb"
      exit 1
    fi
    echo "SUCCESS: RoleBinding was deleted"
- script: |
    set -e
    # Verify managed-by-cluster-argocd label
    label=$(kubectl get namespace test-054-existing-source -o jsonpath='{.metadata.labels.argocd\.argoproj\.io/managed-by-cluster-argocd}' || echo "")
    if [ -n "$label" ]; then
      echo "ERROR: managed-by-cluster-argocd label still exists: $label"
      exit 1
    fi
    echo "SUCCESS: managed-by-cluster-argocd label was removed"
- script: |
    set -e
    # Verify argocd-server command
    serverCommand=$(kubectl get -n test-054-existing-ns deployment/example-argocd-existing-server -o jsonpath='{.spec.template.spec.containers[0].command}' | jq -r '.[]' || echo "")
    if echo "$serverCommand" | grep -q "application-namespaces"; then
      echo "ERROR: argocd-server command"
      echo "Command: $serverCommand"
      exit 1
    fi
    echo "SUCCESS: argocd-server command"
- script: |
    set -e
    # Verify argocd-application-controller command
    controllerCommand=$(kubectl get -n test-054-existing-ns statefulset/example-argocd-existing-application-controller -o jsonpath='{.spec.template.spec.containers[0].command}' | jq -r '.[]' || echo "")
    if echo "$controllerCommand" | grep -q "application-namespaces"; then
      echo "ERROR: argocd-application-controller command"
      echo "Command: $controllerCommand"
      exit 1
    fi
    echo "SUCCESS: argocd-application-controller command"

